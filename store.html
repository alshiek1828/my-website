<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { background-color: #f2f2f2; }
    .navbar-brand { font-weight: bold; font-size: 1.5rem; }
    .product-card { border: none; border-radius: 1rem; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .product-card img { height: 200px; object-fit: cover; }
    #loginModal .modal-content { border-radius: 1rem; }
    .btn-google { background-color: #db4437; color: #fff; }
    .btn-google:hover { background-color: #c33d2e; }
    #adminPanel { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 40px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">Ø³ÙˆÙ‚Ù†Ø§</a>
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-primary ms-auto" data-bs-toggle="modal" data-bs-target="#loginModal" id="authBtn">
          ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ / Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <!-- Products List -->
    <div class="row" id="products-list"></div>

    <!-- Cart Section -->
    <div id="cart-section" class="mt-5" style="display:none;">
      <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
      <ul id="cart-items" class="list-group mb-3"></ul>
      <button onclick="checkout()" class="btn btn-success">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
    </div>

    <!-- Admin Panel (Ù…Ø¶Ù…Ù† Ø¨Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©) -->
    <div id="adminPanel" style="display:none;">
      <h3>ğŸ”¥ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù ğŸ”¥</h3>
      <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø´Ø±ÙØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹!</p>
      <button class="btn btn-danger mb-3" onclick="hideAdmin()">Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</button>
      <!-- Ù…Ø«Ø§Ù„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø´Ø±Ù -->
      <button class="btn btn-warning me-2" onclick="alert('Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬')">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn btn-secondary" onclick="alert('Ø­Ø°Ù Ù…Ù†ØªØ¬')">Ø­Ø°Ù Ù…Ù†ØªØ¬</button>
    </div>
  </div>

  <!-- Login/Register Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h5 class="modal-title mb-3 text-center">ØªØ³Ø¬ÙŠÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h5>
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#signIn">Ø¯Ø®ÙˆÙ„</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#signUp">ØªØ³Ø¬ÙŠÙ„</button></li>
        </ul>
        <div class="tab-content">
          <!-- Sign In -->
          <div class="tab-pane fade show active" id="signIn">
            <div class="d-grid gap-2 mb-2">
              <button class="btn btn-google" onclick="googleSignIn()">ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>
            </div>
            <div class="text-center my-2">Ø£Ùˆ</div>
            <form id="signinForm">
              <input type="email" id="signin-email" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
              <input type="password" id="signin-password" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
              <button type="submit" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <div id="signInStatus" class="mt-2 text-danger"></div>
          </div>
          <!-- Sign Up -->
          <div class="tab-pane fade" id="signUp">
            <div class="d-grid gap-2 mb-2">
              <button class="btn btn-google" onclick="googleSignIn()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø¬ÙˆØ¬Ù„</button>
            </div>
            <div class="text-center my-2">Ø£Ùˆ</div>
            <form id="signupForm">
              <input type="email" id="signup-email" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
              <input type="password" id="signup-password" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" minlength="6" required>
              <button type="submit" class="btn btn-success w-100">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </form>
            <div id="signUpStatus" class="mt-2 text-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, onValue, get, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZt1RSz5d9wyn-C5S3kF8XVYjEldtSZss",
      authDomain: "gmae-fae90.firebaseapp.com",
      databaseURL: "https://gmae-fae90-default-rtdb.firebaseio.com",
      projectId: "gmae-fae90",
      storageBucket: "gmae-fae90.appspot.com",
      messagingSenderId: "768482186329",
      appId: "1:768482186329:web:ae3b54ed2aaaf89d4e0d48",
      measurementId: "G-KGQ0RQ33XS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();
    let cart = [];

    // Sign In
    document.getElementById('signinForm').onsubmit = async e => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(
          auth,
          document.getElementById('signin-email').value,
          document.getElementById('signin-password').value
        );
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      } catch (err) {
        document.getElementById('signInStatus').innerText = err.message;
      }
    };

    // Sign Up
    document.getElementById('signupForm').onsubmit = async e => {
      e.preventDefault();
      try {
        const res = await createUserWithEmailAndPassword(
          auth,
          document.getElementById('signup-email').value,
          document.getElementById('signup-password').value
        );
        await set(ref(db, 'users/' + res.user.uid), { email: res.user.email, role: 'user' });
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      } catch (err) {
        document.getElementById('signUpStatus').innerText = err.message;
      }
    };

    // Google Sign-In
    async function googleSignIn() {
      try {
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        const snap = await get(ref(db, 'users/' + user.uid));
        if (!snap.exists()) {
          await set(ref(db, 'users/' + user.uid), { email: user.email, role: 'user' });
        }
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      } catch (err) {
        document.getElementById('signInStatus').innerText = err.message;
      }
    }

    function hideAdmin() {
      document.getElementById('adminPanel').style.display = 'none';
    }

    // Auth State & Admin Check
    onAuthStateChanged(auth, async user => {
      const btn = document.getElementById('authBtn');
      if (user) {
        btn.innerText = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${user.email}`;
        const snap = await get(ref(db, 'users/' + user.uid));
        const role = snap.val()?.role || 'user';
        if (role === 'admin') {
          document.getElementById('adminPanel').style.display = 'block';
        }
      } else {
        btn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ / Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('adminPanel').style.display = 'none';
      }
      loadProducts();
    });

    // Load Products
    function loadProducts() {
      onValue(ref(db, 'products'), snap => {
        const list = document.getElementById('products-list');
        list.innerHTML = '';
        if (!snap.exists()) {
          list.innerHTML = '<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>';
          return;
        }
        snap.forEach(child => {
          const p = child.val();
          const col = document.createElement('div');
          col.className = 'col-md-4 mb-4';
          col.innerHTML = `
            <div class="card product-card">
              <img src="${p.imageUrl}" class="card-img-top">
              <div class="card-body">
                <h5 class="card-title">${p.name}</h5>
                <p class="card-text">Ø§Ù„Ø³Ø¹Ø±: ${p.price} Ø±ÙŠØ§Ù„</p>
                <button class="btn btn-primary w-100" onclick='addToCart(${JSON.stringify(p)})'>
                  Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                </button>
              </div>
            </div>`;
          list.appendChild(col);
        });
      });
    }

    // Cart
    window.addToCart = p => {
      cart.push(p);
      document.getElementById('cart-section').style.display = 'block';
      updateCart();
    };

    function updateCart() {
      const ul = document.getElementById('cart-items');
      ul.innerHTML = '';
      let total = 0;
      cart.forEach((item, i) => {
        total += parseFloat(item.price);
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between';
        li.textContent = `${item.name} - ${item.price} Ø±ÙŠØ§Ù„`;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-danger';
        btn.textContent = 'Ø­Ø°Ù';
        btn.onclick = () => { cart.splice(i,1); updateCart(); };
        li.appendChild(btn);
        ul.appendChild(li);
      });
      const totalLi = document.createElement('li');
      totalLi.className = 'list-group-item fw-bold text-end';
      totalLi.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø±ÙŠØ§Ù„`;
      ul.appendChild(totalLi);
    }

    // Checkout
    window.checkout = async () => {
      const user = auth.currentUser;
      if (!user) return alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      const order = {
        items: cart,
        total: cart.reduce((sum,p) => sum + parseFloat(p.price), 0),
        userEmail: user.email,
        timestamp: Date.now()
      };
      await push(ref(db, 'orders'), order);
      alert('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…');
      cart = [];
      updateCart();
      document.getElementById('cart-section').style.display = 'none';
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
