<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سوق إلكتروني</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f8f9fa; }
    .admin-panel, #cart-section { display: none; }
    .product { border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 10px 0; background-color: #fff; }
    #auth-section { position: fixed; top: 20px; left: 20px; z-index: 999; }
    #login-form { display: none; }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">سوق إلكتروني</h1>  <!-- قسم المصادقة -->  <div id="auth-section">
    <button class="btn btn-outline-primary" onclick="toggleLoginForm()">تسجيل دخول</button>
    <div id="login-form" class="mt-2 p-3 bg-white rounded shadow-sm">
      <input type="email" id="email" placeholder="البريد الإلكتروني" class="form-control mb-2">
      <input type="password" id="password" placeholder="كلمة السر" class="form-control mb-2">
      <button onclick="emailSignIn()" class="btn btn-primary w-100 mb-2">دخول بالبريد</button>
      <button onclick="googleSignIn()" class="btn btn-danger w-100 mb-2">دخول بجوجل</button>
      <button onclick="signUp()" class="btn btn-success w-100">إنشاء حساب</button>
      <button onclick="signOut()" class="btn btn-secondary w-100 mt-2">تسجيل خروج</button>
    </div>
  </div>  <!-- لوحة الأدمن -->  <div class="admin-panel mt-5">
    <h2>لوحة التحكم (أدمن)</h2>
    <div class="mb-3">
      <input type="text" id="product-name" placeholder="اسم المنتج" class="form-control mb-2">
      <input type="number" id="product-price" placeholder="السعر" class="form-control mb-2">
      <input type="file" id="product-image" class="form-control mb-2">
      <button onclick="addProduct()" class="btn btn-success">إضافة منتج</button>
    </div>
  </div>  <!-- عرض المنتجات -->  <div id="products-list" class="row"></div>  <!-- سلة التسوق -->  <div id="cart-section" class="mt-5">
    <h3>سلة المشتريات</h3>
    <ul id="cart-items" class="list-group mb-2"></ul>
    <button onclick="checkout()" class="btn btn-warning">شراء الآن</button>
  </div>  <!-- Firebase SDKs -->  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZt1RSz5d9wyn-C5S3kF8XVYjEldtSZss",
      authDomain: "gmae-fae90.firebaseapp.com",
      databaseURL: "https://gmae-fae90-default-rtdb.firebaseio.com",
      projectId: "gmae-fae90",
      storageBucket: "gmae-fae90.appspot.com",
      messagingSenderId: "768482186329",
      appId: "1:768482186329:web:ae3b54ed2aaaf89d4e0d48",
      measurementId: "G-KGQ0RQ33XS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let cart = [];

    window.toggleLoginForm = () => {
      const form = document.getElementById('login-form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    };

    async function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await set(ref(db, 'users/' + userCredential.user.uid), { email, role: 'user' });
        alert('تم إنشاء الحساب ✅');
      } catch (e) {
        alert('خطأ في إنشاء الحساب: ' + e.message);
      }
    }

    async function emailSignIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert('خطأ في تسجيل الدخول: ' + e.message);
      }
    }

    async function googleSignIn() {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const snap = await get(ref(db, 'users/' + user.uid));
        if (!snap.exists()) {
          await set(ref(db, 'users/' + user.uid), { email: user.email, role: 'user' });
        }
      } catch (e) {
        alert('خطأ في تسجيل الدخول بجوجل: ' + e.message);
      }
    }

    window.signOut = async () => {
      await signOut(auth);
      document.querySelector('.admin-panel').style.display = 'none';
    };

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        if (!user.isAnonymous) {
          const snap = await get(ref(db, 'users/' + user.uid + '/role'));
          if (snap.exists() && snap.val() === 'admin') document.querySelector('.admin-panel').style.display = 'block';
          else document.querySelector('.admin-panel').style.display = 'none';
        }
      }
      loadProducts();
    });

    window.addProduct = async () => {
      const name = document.getElementById('product-name').value;
      const price = document.getElementById('product-price').value;
      const file = document.getElementById('product-image').files[0];
      if (!name || !price || !file) return alert('يرجى ملء الحقول');
      const imgRef = storageRef(storage, 'images/' + file.name);
      await uploadBytes(imgRef, file);
      const url = await getDownloadURL(imgRef);
      const prodRef = push(ref(db, 'products'));
      await set(prodRef, { name, price, imageUrl: url });
      loadProducts();
    };

    function loadProducts() {
      onValue(ref(db, 'products'), snap => {
        const list = document.getElementById('products-list'); list.innerHTML = '';
        snap.forEach(c => {
          const p = c.val();
          const col = document.createElement('div'); col.className = 'product col-md-4';
          col.innerHTML = `
            <img src="${p.imageUrl}" class="img-fluid mb-2" />
            <h5>${p.name}</h5>
            <p>السعر: ${p.price} ريال</p>
            <button class="btn btn-info mb-3" onclick='addToCart(${JSON.stringify(p)})'>أضف للسلة</button>
          `;
          list.appendChild(col);
        });
      });
    }

    window.addToCart = p => { cart.push(p); document.getElementById('cart-section').style.display = 'block'; updateCart(); };

    function updateCart() {
      const ul = document.getElementById('cart-items'); ul.innerHTML = '';
      cart.forEach((i, idx) => {
        const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between';
        li.textContent = `${i.name} - ${i.price} ريال`;
        const btn = document.createElement('button'); btn.textContent = 'حذف'; btn.className = 'btn btn-sm btn-danger';
        btn.onclick = () => { cart.splice(idx, 1); updateCart(); };
        li.appendChild(btn); ul.appendChild(li);
      });
    }

    window.checkout = () => { alert('تم تأكيد الطلب ✅'); cart = []; updateCart(); document.getElementById('cart-section').style.display = 'none'; };
  </script>  <!-- سلة الشراء -->  <div id="cart-section" class="mt-5">
    <h3>سلة المشتريات</h3>
    <ul id="cart-items" class="list-group mb-3"></ul>
    <button onclick="checkout()" class="btn btn-warning">شراء الآن</button>
  </div>
</body>
</html>
