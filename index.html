<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لعبة كرة الوجه الشاملة - موقع تفاعلي</title>
    <style>
      /* Reset and base styles */
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to bottom, #1c1c1c, #2b2b2b);
        color: #fff;
        direction: rtl;
        line-height: 1.5;
      }
      header {
        text-align: center;
        padding: 20px;
      }
      header h1 {
        font-size: 2.5em;
        color: #00ffe7;
        text-shadow: 0 0 10px #00ffe7;
      }
      nav {
        background: #333;
        text-align: center;
        padding: 10px 0;
      }
      nav button {
        background: #ff0066;
        color: #fff;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      nav button:hover,
      nav button.active {
        background: #ff3388;
        transform: scale(1.05);
      }
      .section {
        display: none;
        padding: 20px;
      }
      .active {
        display: block;
      }
      /* Registration styles */
      #registration {
        max-width: 400px;
        margin: 50px auto;
        text-align: center;
        padding: 20px;
        background: #444;
        border-radius: 10px;
      }
      #registration input {
        width: 80%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border: none;
      }
      .btn {
        background: #00aaff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px;
        transition: background 0.3s;
      }
      .btn:hover {
        background: #33bbff;
      }
      /* Admin panel styles */
      #admin-panel {
        display: none;
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        background: #555;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px #000;
        z-index: 1000;
        width: 90%;
        max-width: 400px;
      }
      #admin-panel h2 {
        text-align: center;
        margin-bottom: 15px;
      }
      #admin-panel button {
        width: 100%;
        margin: 5px 0;
      }
      /* Leaderboard Table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #666;
        padding: 10px;
        text-align: center;
      }
      th {
        background: #222;
      }
      /* Game area styles */
      #game-area {
        text-align: center;
        padding: 20px;
      }
      .emoji-btn {
        font-size: 2em;
        margin: 10px;
        padding: 10px;
        border: none;
        background: #777;
        color: #fff;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .emoji-btn:hover {
        transform: scale(1.1);
      }
      #countdown {
        font-size: 2em;
        margin: 15px;
      }
      /* Key layout container styles (simulates inline keyboards) */
      .key-layout {
        display: inline-block;
        margin-top: 15px;
        text-align: center;
      }
      .key-row {
        margin: 5px 0;
      }
      .key-button {
        background: #444;
        border: 1px solid #666;
        margin: 3px;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
      }
      footer {
        text-align: center;
        padding: 10px;
        margin-top: 20px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <!-- Registration Screen -->
    <div id="registration" class="section active">
      <h2>تسجيل الدخول</h2>
      <input type="text" id="reg-name" placeholder="أدخل اسمك" />
      <input type="text" id="reg-username" placeholder="اختر يوزرك الخاص" />
      <button class="btn" onclick="registerUser()">تسجيل</button>
    </div>
    <!-- Main Content -->
    <div id="main-content" class="section">
      <header>
        <h1>بوابة الألعاب والاختبارات</h1>
      </header>
      <nav>
        <button data-section="game" onclick="showSection('game')">اللعبة</button>
        <button data-section="leaderboard" onclick="showSection('leaderboard')">لوحة المتصدرين</button>
        <button onclick="openAdminPanel()">لوحة الأدمن</button>
        <button onclick="openSettings()">الإعدادات</button>
      </nav>
      <!-- Game Section -->
      <div id="game" class="section active">
        <h2>لعبة كرة الوجه المبتسم - المرحلة <span id="current-level">1</span></h2>
        <p id="game-status">اضغط على "ابدأ التحدي" لبدء المرحلة الأولى.</p>
        <buttonth>الترتيب</th>
              <th>الاسم</th>
              <th>النقاط</th>
              <th>المستوى</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- سيتم تعبئته ديناميكيًا -->
          </tbody>
        </table>
      </div>
    </div>
    <!-- Admin Panel (protected with secret code "0000") -->
    <div id="admin-panel">
      <h2>لوحة الأدمن</h2>
      <div id="admin-options">
        <button class="btn" onclick="adminAction('ban')">حظر مستخدم</button>
        <button class="btn" onclick="adminAction('unban')">فك حظر مستخدم</button>
        <button class="btn" onclick="adminAction('stats')">عرض إحصائيات اللعبة</button>
        <button class="btn" onclick="adminAction('reset')">إعادة تعيين النقاط</button>
      </div>
      <button class="btn" onclick="closeAdminPanel()">إغلاق الأدمن</button>
    </div>
    <footer>
      &copy; 2025 - Made with madness by ツ 《👑》Ͳ３ 《ش90.firebasestorage.app",
        messagingSenderId: "768482186329",
        appId: "1:768482186329:web:18937587e530f8674e0d48",
        measurementId: "G-V4ZLJ4BJGD",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
  
      // توليد UUID مبسط وتخزينه في localStorage للزائر
      function generateId() {
        return "xxxx-xxxx-xxxx".replace(/x/g, () =>
          Math.floor(Math.random() * 16).toString(16)
        );
      }
      let visitorId = localStorage.getItem("visitorId");
      if inline keyboards) -->
    <script>
      // These keys simulate various stage layouts (such as inline-keyboard layouts in your Game.php code)
      const stageKeys = [
        {"inline_keyboard": [
          [{"text": "☺️", "callback_data": "go"}, {"text": "☹️", "callback "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}]
        ]},
        {"inline_keyboard": [
          [{"text": "☹️", "callback_data": "no"}, {"text": "☺️", "callback_data": "go"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}]
        ]},
        {"inline_keyboard": [
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☺️", "callback_data": "go"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}]
        ]},
        {"inline_keyboard": [
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☺️", "callback_data": "go"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}]
        ]},
        {"inline_keyboard": [
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☺", "callback_data": "goo"}, {"text": "☹️", "callback_data": "no"}],
          [{"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}, {"text": "☹️", "callback_data": "no"}]
        ]}
      ];
  
      // Choose a random stage key layout from the array
      function getRandomStageKey() {
        const idx = Math.floor(Math.random() * stageKeys.length);
        return stageKeys[idx];
      }
  
      // Render the key layout as HTML buttons
      function renderKeyLayout(keyData) {
        const container = document.getElementById("key-layout-container");
        container.innerHTML = "";
        const layoutDiv = document.createElement("div");
        layoutDiv.className = "key-layout";
        keyData.inline_keyboard.forEach((row) => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "key-row";
          row.forEach((btnData) => {
            const btn = document.createElement("button");
            btn.className = "key-button";
            btn.textContent = btnData.text;
            btn.addEventListener("click", () => {
              if (btnData.callback_data === "go" || btnData.callback_data === "goo") {
                alert("تم اختيار الإجابة الصحيحة!");
              } else {
                alert("للأسف، الإجابة خاطئة.");
              }
            });
            rowDiv.appendChild(btn);
          });
          layoutDiv.appendChild(rowDiv);
        });
        container.appendChild(layoutDiv);
      }
    </script>
    <!-- Main Application Script -->
    <script>
      // Global variables for the current user and level
      let currentUser = null; // { name, username, userId, score, level }
  
      // On page load, if a user is already stored then load that data
      window.onload = function () {
        const storedUser = localStorage.getItem("currentUser");
        if (storedUser) {
          currentUser = JSON.parse(storedUser);
          document.getElementById("registration").classList.remove("active");
          document.getElementById("main-content").classList.add("active");
          document.getElementById("current-level").textContent = currentUser.level || 1;
          checkBanStatus();
        }
      };
  
      // Registration function: now simply collecting user name and username
      function registerUser() {
        const name = document.getElementById("reg-name").value.trim();
        const username = document.getElementById("reg-username").value.trim();
        if (!name || !username) {
          alert("الرجاء إدخال الاسم واليوزر الخاص بك");
          return;
        }
        const userId =
          username.toLowerCase() + "_" + Math.random().toString(36).substr(2, 5);
        currentUser = { name, username, userId, score: 0, level: 1 };
        db.ref("users/" + userId).set(currentUser, (error) => {
          if (error) {
            alert("فشل التسجيل، حاول مرة أخرى");
          } else {
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            document.getElementById("registration").classList.remove("active");
            document.getElementById("main-content").classList.add("active");
            checkBanStatus();
          }
        });
      }
  
      // Section switching function
      function showSection(sectionId) {
        document
          .querySelectorAll("#main-content > .section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
        if (sectionId === "leaderboard") renderLeaderboard();
      }
  
      // ----------------- Game Logic with Stages -----------------
      let challengeTimer;
      let challengeTimeLeft;
      const correctEmoji = "☺️";
      const wrongEmojis = ["☹️", "😢", "😞", "😟", "🙁"];
  
      // Start a challenge; adjust the challenge based on the current level
      function startChallenge() {
        checkBanStatus().then((banData) => {
          if (banData && banData.banUntil && Date.now() < banData.banUntil) {
            alert(
              "لا يمكنك بدء اللعبة لأنك محظور. الوقت المتبقي للحظر: " +
                Math.ceil((banData.banUntil - Date.now()) / 60000) +
                " دقيقة."
            );
            return;
          }
          const level = currentUser.level || 1;
          challengeTimeLeft = level === 1 ? 5 : 3;
          document.getElementById("game-status").textContent =
            "المرحلة " + level + ": ابحث عن الرمز التعبيري المبتسم!";
          const emojiContainer = document.getElementById("emoji-container");
          emojiContainer.innerHTML = "";
          // Increase number of buttons as level increases
          const totalButtons = 8 + (level - 1) * 2;
          const correctIndex = Math.floor(Math.random() * totalButtons);
          for (let i = 0; i < totalButtons; i++) {
            const btn = document.createElement("button");
            btn.className = "emoji-btn";
            btn.textContent =
              i === correctIndex
                ? correctEmoji
                : wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
            btn.onclick = () => checkAnswer(btn.textContent);
            emojiContainer.appendChild(btn);
          }
          document.getElementById("countdown").textContent = challengeTimeLeft;
          challengeTimer = setInterval(() => {
            challengeTimeLeft--;
            document.getElementById("countdown").textContent = challengeTimeLeft;
            if (challengeTimeLeft <= 0) {
              clearInterval(challengeTimer);
              document.getElementById("game-status").textContent =
                "انتهى الوقت! حاول مرة أخرى.";
              updateScore(false);
              renderKeyLayout(getRandomStageKey());
            }
          }, 1000);
        });
      }
  
      function checkAnswer(selected) {
        clearInterval(challengeTimer);
        if (selected === correctEmoji) {
          document.getElementById("game-status").textContent =
            "أحسنت! إجابتك صحيحة.";
          currentUser.score++;
          if (currentUser.level === 1) {
            currentUser.level = 2;
            alert("تهانينا! لقد انتقلت إلى المرحلة الثانية.");
          }
          updateScore(true);
          renderKeyLayout(getRandomStageKey());
        } else {
          document.getElementById("game-status").textContent =
            "للأسف، إجابتك خاطئة.";
          updateScore(false);
          renderKeyLayout(getRandomStageKey());
        }
        document.getElementById("countdown").textContent = "";
        document.getElementById("emoji-container").innerHTML = "";
        document.getElementById("current-level").textContent =
          currentUser.level || 1;
      }
  
      function updateScore(correct) {
        db.ref("users/" + currentUser.userId + "/score").set(currentUser.score);
        db.ref("users/" + currentUser.userId + "/level").set(currentUser.level);
        db.ref("leaderboard/" + currentUser.userId).set({
          name: currentUser.name,
          score: currentUser.score,
          level: currentUser.level,
        });
      }
  
      // ----------------- Leaderboard Rendering -----------------
      function renderLeaderboard() {
        const lbBody = document.getElementById("leaderboard-body");
        lbBody.innerHTML = "";
        db.ref("leaderboard")
          .orderByChild("score")
          .once("value", (snapshot) => {
            let leaderboard = [];
            snapshot.forEach((child) => {
              leaderboard.push(child.val());
            });
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard.forEach((entry, index) => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${index + 1}</td><td>${entry.name}</td><td>${entry.score}</td><td>${
                entry.level || 1
              }</td>`;
              lbBody.appendChild(row);
            });
          });
      }
  
      // ----------------- Ban Handling -----------------
      function checkBanStatus() {
        if (!currentUser) return Promise.resolve(null);
        return db
          .ref("bans/" + currentUser.userId)
          .get()
          .then((snapshot) => {
            return snapshot.exists() ? snapshot.val() : null;
          });
      }
  
      // ----------------- Admin Panel -----------------
      const ADMIN_CODE = "0000"; // رمز دخول الأدمن
      function openAdminPanel() {
        const code = prompt("أدخل الرمز للوصول إلى لوحة الأدمن:");
        if (code === ADMIN_CODE) {
          document.getElementById("admin-panel").style.display = "block";
        } else {
          alert("الرمز غير صحيح.");
        }
      }
      function closeAdminPanel() {
        document.getElementById("admin-panel").style.display = "none";
      }
      function adminAction(action) {
        switch (action) {
          case "ban":
            const banUserId = prompt("أدخل معرف المستخدم لحظره:");
            const banMinutes = parseInt(prompt("أدخل مدة الحظر بالدقائق:"), 10);
            if (banUserId && banMinutes) {
              const banUntil = Date.now() + banMinutes * 60000;
              db.ref("bans/" + banUserId).set({ banUntil });
              alert("تم حظر المستخدم " + banUserId + " لمدة " + banMinutes + " دقيقة.");
            }
            break;
          case "unban":
            const unbanUserId = prompt("أدخل معرف المستخدم لفك الحظر:");
            if (unbanUserId) {
              db.ref("bans/" + unbanUserId).remove();
              alert("تم فك الحظر عن المستخدم " + unbanUserId);
            }
            break;
          case "stats":
            db.ref("users")
              .once("value")
              .then((snapshot) => {
                alert("عدد اللاعبين المسجلين: " + snapshot.numChildren());
              });
            break;
          case "reset":
            if (confirm("هل تريد إعادة تعيين جميع النقاط؟")) {
              db.ref("leaderboard").remove();
              db.ref("users").once("value", (snapshot) => {
                snapshot.forEach((child) => {
                  db.ref("users/" + child.key + "/score").set(0);
                });
              });
              alert("تم إعادة تعيين النقاط.");
            }
            break;
          default:
            alert("أمر غير معروف");
        }
      }
  
      // ----------------- Settings -----------------
      function openSettings() {
        let newName = prompt("أدخل اسمك الجديد:", currentUser.name);
        if (newName && newName !== currentUser.name) {
          currentUser.name = newName;
          localStorage.setItem("currentUser", JSON.stringify(currentUser));
          db.ref("users/" + currentUser.userId + "/name").set(newName);
          alert("تم تحديث الاسم!");
        }
        if (confirm("هل تريد نسخ معرفك؟")) {
          navigator.clipboard.writeText(currentUser.userId).then(() => {
            alert("تم نسخ المعرف!");
          });
        }
      }
    </script>
  </body>
</html>
